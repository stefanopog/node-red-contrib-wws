
<script type="text/javascript">
    RED.nodes.registerType('wws-webhook',{
        category: 'Watson Work',
        color:"#11ABA5",
        defaults: {
            account: {
                type: "wws-credentials",
                required: true
            },
            webhookSecret: {
                value: "", 
                required: true
            },
            webhookPath: {
                value: "/workspace/hook", 
                required: true
            },
            filterOutputs: {
                    value: false,
                    required: false
            },
            o_messageCreated : {
                    value: false,
                    required: false
            },
            o_messageEdited : {
                    value: false,
                    required: false
            },
            o_messageDeleted : {
                    value: false,
                    required: false
            },
            o_spaceMembersRemoved : {
                    value: false,
                    required: false
            },
            o_spaceMembersAdded : {
                    value: false,
                    required: false
            },
            o_spaceUpdated : {
                    value: false,
                    required: false
            },
            o_spaceDeleted : {
                    value: false,
                    required: false
            },
            o_annotationAdded : {
                    value: false,
                    required: false
            },
            o_annotationEdited : {
                    value: false,
                    required: false
            },
            o_annotationRemoved : {
                    value: false,
                    required: false
            },
            o_reactionAdded : {
                    value: false,
                    required: false
            },
            o_reactionRemoved : {
                    value: false,
                    required: false
            },
            hidden_string : {
                value : "",
                required : false
            },
            name: {
                value: ""
            },
            outputs: {
                //
                //  this is the same "outputs" variable that is used to define the number of outputs of the node instance
                //  It is promoted here in order to make sure it can be programmatically modified
                //
                value:1
            }
        },
        credentials: {
            webhookSecret: {
                type: "text"
            }
        },
        inputs: 0,
        outputs: 1,
        icon: "wws.png",
        outputLabels: function(index) { 
            //
            //  This function dynamically assigns a label to each of the output.
            //  The label assigned to each output reflects the value entered in the wwsActionsList input
            //  An additional label is generated for the last output, to cover the "OTHERWISE" case
            //
            var temp = this.hidden_string.split(',');
            return temp[index].trim();
        },
        label: function() {
            if (this.name) {
                return this.name;
            } else {
                return "["+this.webhookPath+"] webhook";
            }
        },
        paletteLabel: "webhook",
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: _setupWebhookNode,
        oneditsave : _saveWebhookNode
    });


    function _setupWebhookNode() {
        _filterOutputsWebhookNode();
    }

    function _saveWebhookNode() {
        if (document.querySelector("#node-input-filterOutputs").checked){ 
            let count = 0;
            let out = [];

            if (document.querySelector("#node-input-o_messageCreated").checked) {count += 1; out.push("message-created")};
            if (document.querySelector("#node-input-o_messageEdited").checked) {count += 1; out.push("message-edited")};
            if (document.querySelector("#node-input-o_messageDeleted").checked)  {count += 1; out.push("message-deleted")};
            if (document.querySelector("#node-input-o_annotationAdded").checked)  {count += 1; out.push("message-annotation-added")};
            if (document.querySelector("#node-input-o_annotationEdited").checked)  {count += 1; out.push("message-annotation-edited")};
            if (document.querySelector("#node-input-o_annotationRemoved").checked)  {count += 1; out.push("message-annotation-removed")};
            if (document.querySelector("#node-input-o_spaceMemberAdded").checked)  {count += 1; out.push("space-members-added")};
            if (document.querySelector("#node-input-o_spaceMemberRemoved").checked)  {count += 1; out.push("space-members-removed")};
            if (document.querySelector("#node-input-o_spaceUpdated").checked)  {count += 1; out.push("space-updated")};
            if (document.querySelector("#node-input-o_spaceDeleted").checked)  {count += 1; out.push("space-deleted")};
            if (document.querySelector("#node-input-o_reactionAdded").checked)  {count += 1; out.push("reaction-added")};
            if (document.querySelector("#node-input-o_reactionRemoved").checked)  {count += 1; out.push("reaction-removed")};
            this.outputs = count;
            this.hidden_string = out.join(',');
        } else { 
            this.outputs = 1;
            this.hidden_string = "output";
        } 

    }

    function _filterOutputsWebhookNode() { 
        if (document.querySelector("#node-input-filterOutputs").checked){ 
            document.querySelector("#outputDetails").style.display = "inline"; 
        } else { 
            document.querySelector("#outputDetails").style.display = "none"; 
        } 
    }
    
</script>

<script type="text/x-red" data-template-name="wws-webhook">
    <div class="form-row">
        <label for="node-input-account"><i class="fa fa-user"></i> App Name</label>
        <input type="text" id="node-input-account">
    </div>
    <div class="form-row">
        <label for="node-input-webhookSecret"><i class="fa fa-user-secret"></i> Hook Secret</label>
        <input type="password" id="node-input-webhookSecret" autocomplete="off">
    </div>
    <div class="form-row">
        <label for="node-input-webhookPath"><i class="fa fa-cog"></i> Hook Path</label>
        <input type="text" id="node-input-webhookPath">
    </div>


    <div class="form-row">
        <label for="node-input-filterOutputs"><i></i> Filter Outputs ?</label>
        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-filterOutputs" onchange="_filterOutputsWebhookNode()"></input>
    </div>
    <div class="form-row" id="outputDetails">
        <table style="width: 100%">
            <tr>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_messageCreated"><i></i> Message Created</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_messageCreated"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_messageEdited"><i></i> Message Edited</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_messageEdited"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_messageDeleted"><i></i> Message Deleted</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_messageDeleted"></input>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_annotationAdded"><i></i> Annotation Added</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_annotationAdded"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_annotationEdited"><i></i> Annotation Edited</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_annotationEdited"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_annotationRemoved"><i></i> Annotation Removed</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_annotationRemoved"></input>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_spaceUpdated"><i></i> Space Updated</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_spaceUpdated"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_spaceDeleted"><i></i> Space Deleted</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_spaceDeleted"></input>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_spaceMemberAdded"><i></i> Member Added</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_spaceMemberAdded"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_spaceMemberRemoved"><i></i> Member Removed</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_spaceMemberRemoved"></input>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_reactionAdded"><i></i> Reaction Added</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_reactionAdded"></input>
                    </div>
                </td>
                <td>
                    <div class="form-row">
                        <label for="node-input-o_reactionRemoved"><i></i> Reaction Removed</label>
                        <input style="display: inline-block; width: auto; vertical-align: top;" type="checkbox" name="limitCB" id="node-input-o_reactionRemoved"></input>
                    </div>
                </td>
            </tr>
        </table>
                                                                
        <br />
        <br />
    </div>
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">
		<h4>Tip</h4>
		<p>To see which message types are received by this webhook you can easily obeserve it by looking at the nodes status information.</p>
	</div>
</script>

<script type="text/x-red" data-help-name="wws-webhook">
    <p>Node to receive webhook events published by <a href="https://workspace.ibm.com">IBM Watson Workspace</a>.</p>
    <h3>Instructions</h3>
    <p>
        Read the <a href="https://developer.watsonwork.ibm.com/docs/apps/prepare-your-app-to-run" target="_blank">following instructions</a> provided by the Watson Work Developer Team.</br>
        This provides you with the ability to enter the required information for the node to work properly.<br/>
        <b>TIP:</b> Do not enable the webhook during the event registration, as you need to configure this node first.
    </p>
    <ol>
        <li>Select or create configure a workspace app</li>
        <li>Enter the Webhook Secret provided to you during the <a href="https://developer.watsonwork.ibm.com/apps" target="_blank">Watson Work App registration process.</a></li>
        <li>Check, if Webhook URL matches with the one you entered during the Watson Work App event registration page.</li>
    </ol>
    <p>
        Once the workspace app and the webhook secret have been entered, you can deploy the flow with this configured node.</br>
        Now you can enable the webhook by clicking the <code>Enable</code> button on the event registration page.
    </p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">string | object</span>
        </dt>
        <dd>The webhook event received from Watson Work. Check the reference documentation, to understand and know the different event types.</dd>
        <dt>spaceId
            <span class="property-type">string</span>
        </dt>
        <dd>The space ID from which this Webhook Event has been received.</dd>
        <dt>messageId
            <span class="property-type">string</span>
        </dt>
        <dd>The message ID - depending of the type of the event this is either the actual message OR the message to which this event belongs to e.g. annotations.</dd>
        <dt>type
            <span class="property-type">enum</span>
        </dt>
        <dd>The name of the event. See the Details section for further information. </dd>
        <dt>event
                <span class="property-type">object</span>
            </dt>
            <dd>The raw webhook event received from Watson Work.</dd>
        <dt class="optional">spaceName <span class="property-type">string | undefined</span></dt>
        <dd> The display name of the space. Depending on the event type this value is present.</dd>
    </dl>
    <h3>Details</h3>
    <p>Depending on the event type, different values will appear. Ideally a switch node should be added as the following node, to push the message according to the type.<br/>
    The following message types are supported.</p>
    <ul>
            <li><code>message-created</code></li>
            <li><code>message-edited</code></li>
            <li><code>message-deleted</code></li>
            <li><code>message-annotation-added</code></li>
            <li><code>message-annotation-edited</code></li>
            <li><code>message-annotation-removed</code></li>
            <li><code>space-members-added</code></li>
            <li><code>space-members-removed</code></li>
            <li><b>NEW</b> <code>reaction-added</code></li>
            <li><b>NEW</b> <code>reaction-removed</code></li>
            <li><b>NEW</b> <code>space-updated</code></li>
            <li><b>NEW</b> <code>space-deleted</code></li>

            
    </ul>
    <h5>message-created</h5>
    <p>This event is issued when an user (not an app) is posting a message to this space.</p>
    <p>Example message</p>
    <pre>
{
    "payload": "Hello App!",
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsSpaceName": "NodeRed Test",
    "wwsMessageId": "5ac57856e4b0758fdb1d14af",
    "wwsType": "message-created",
    "wwsUserName": "Arne Sutor",
    "wwsUserId": "54f13685-35f7-468e-939e-28f8bed06a87",
    "wwsEvent": {
        "spaceName": "NodeRed Test",
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "messageId": "5ac57856e4b0758fdb1d14af",
        "time": 1522890838960,
        "type": "message-created",
        "userName": "Arne Sutor",
        "userId": "54f13685-35f7-468e-939e-28f8bed06a87",
        "contentType": "text/markdown",
        "content": "Hello App!"
    },
    "_msgid": "e962a795.d92bd8"
}
    </pre>
    <h5>message-deleted</h5>
    <p>This event is issued when an user has removed the message from this space.</p>
    <p>Example message</p>
    <pre>
{
    "payload": "5ac57691e4b01fb480a7d493",
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsMessageId": "5ac57691e4b01fb480a7d493",
    "wwsType": "message-deleted",
    "wwsEvent": {
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "messageId": "5ac57691e4b01fb480a7d493",
        "time": 1522891128960,
        "type": "message-deleted"
    },
    "_msgid": "7ae0081f.b9cad8"
}
    </pre>
    <h5>message-annotation-added</h5>
    <p>This event is issued when an app is enriching the message or respond to a particular user message.</p>
    <p>Example message</p>
    <pre>
{
    "payload": {
        "language": "de",
        "docSentiment": {
            "score": 0,
            "type": "neutral"
        }
    },
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsSpaceName": "NodeRed Test",
    "wwsMessageId": "5ac57915e4b0b65c47d9fb15",
    "wwsType": "message-annotation-added",
    "wwsAnnotationId": "5ac57915e4b0797dd985c834",
    "wwsAnnotationService": "toscana-aip-nlc-consumer-client-id",
    "wwsAnnotationType": "message-nlp-docSentiment",
    "wwsEvent": {
        "spaceName": "NodeRed Test",
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "annotationPayload": "{\"language\":\"de\",\"docSentiment\":{\"score\":0.0,\"type\":\"neutral\"}}",
        "messageId": "5ac57915e4b0b65c47d9fb15",
        "annotationType": "message-nlp-docSentiment",
        "annotationId": "5ac57915e4b0797dd985c834",
        "time": 1522891029779,
        "type": "message-annotation-added",
        "userId": "toscana-aip-nlc-consumer-client-id"
    },
    "_msgid": "48b1e538.52c2dc"
}
    </pre>
    <h5>message-annotation-edited</h5>
    <p>This event is issued when an app is updating the annotation (e.g. to create moments) of a user message.</p>
    <p>Example message</p>
    <pre>
{
    "payload": {
        "hidden": false,
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "momentSummary": {
            "phrases": [],
            "mostRelevantMessage": {
                "messageId": "5ac57691e4b01fb480a7d493",
                "published": 1522890385417
            }
        },
        "momentId": "d371dfee5d9aa30eafcabdd9dd656dce992ed2eb",
        "algorithm": "timegap",
        "participants": [
            {
                "authorId": "54f13685-35f7-468e-939e-28f8bed06a87",
                "messageCount": 3
            }
        ],
        "startMessage": {
            "messageId": "5ac57691e4b01fb480a7d493",
            "published": 1522890385417
        },
        "lastUpdatedMessage": {
            "messageId": "5ac57856e4b0758fdb1d14af",
            "published": 1522890838960
        },
        "momentVersion": 6
    },
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsSpaceName": "NodeRed Test",
    "wwsMessageId": "5ac57691e4b01fb480a7d493",
    "wwsType": "message-annotation-edited",
    "wwsAnnotationId": "5ac57691e4b016de47756a6e",
    "wwsAnnotationService": "toscana-service-moment-identification-client-id",
    "wwsAnnotationType": "conversation-moment",
    "wwsEvent": {
        "spaceName": "NodeRed Test",
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "annotationPayload": "{\"hidden\":false,\"spaceId\":\"5ac3a40fe4b0b569843a146b\",\"momentSummary\":{\"phrases\":[],\"mostRelevantMessage\":{\"messageId\":\"5ac57691e4b01fb480a7d493\",\"published\":1522890385417}},\"momentId\":\"d371dfee5d9aa30eafcabdd9dd656dce992ed2eb\",\"algorithm\":\"timegap\",\"participants\":[{\"authorId\":\"54f13685-35f7-468e-939e-28f8bed06a87\",\"messageCount\":3}],\"startMessage\":{\"messageId\":\"5ac57691e4b01fb480a7d493\",\"published\":1522890385417},\"lastUpdatedMessage\":{\"messageId\":\"5ac57856e4b0758fdb1d14af\",\"published\":1522890838960},\"momentVersion\":6}",
        "messageId": "5ac57691e4b01fb480a7d493",
        "annotationType": "conversation-moment",
        "annotationId": "5ac57691e4b016de47756a6e",
        "time": 1522890839388,
        "type": "message-annotation-edited",
        "userId": "toscana-service-moment-identification-client-id"
    },
    "_msgid": "25bf8b59.e2bb84"
}
    </pre>
    <h5>message-annotation-removed</h5>
    <p>This event is issued when an app has removed the annotation of a particular user message.</p>
    <p>Example message</p>
    <pre>
        No example provided yet.
    </pre>
    <h5>space-members-added</h5>
    <p>This event is issued when an user or an app has been added to this space. This can be usefull if the app needs to track to which spaces this app belongs to.</p>
    <p>Example message</p>
    <pre>
{
    "payload": [
        "99b7f797-17ba-4666-a595-2668834822e5"
    ],
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsSpaceName": "NodeRed Test",
    "wwsType": "space-members-added",
    "wwsEvent": {
        "spaceName": "NodeRed Test",
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "time": 1522891286786,
        "type": "space-members-added",
        "memberIds": [
            "99b7f797-17ba-4666-a595-2668834822e5"
        ]
    },
    "_msgid": "bad5605b.f904a"
}
    </pre>
    <h5>space-members-removed</h5>
    <p>This event is issued when an user or an app has been removed from this space. This can be usefull if the app needs to track to which spaces this app belongs to.</p>
    <p>Example message</p>
    <pre>
{
    "payload": [
        "99b7f797-17ba-4666-a595-2668834822e5"
    ],
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsSpaceName": "NodeRed Test",
    "wwsType": "space-members-removed",
    "wwsEvent": {
        "spaceName": "NodeRed Test",
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "time": 1522891359071,
        "type": "space-members-removed",
        "memberIds": [
            "99b7f797-17ba-4666-a595-2668834822e5"
        ]
    },
    "_msgid": "d6f846d9.d94ca8"
}
    </pre>
    <h5><b>NEW</b> reaction-added</h5>
    <p>This event is issued when an user or app has added a reaction (e.g. emoticons) to a particular user message.</p>
    <p>Example message</p>
    <pre>
{
    "payload": "üëç",
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsType": "reaction-added",
    "wwsReactor": "54f13685-35f7-468e-939e-28f8bed06a87",
    "wwsRelatedMessage": "5ac57915e4b0b65c47d9fb15",
    "wwsReactionType": "MESSAGE",
    "wwsEvent": {
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "reaction": "üëç",
        "time": 1522891206509,
        "type": "reaction-added",
        "userId": "54f13685-35f7-468e-939e-28f8bed06a87",
        "objectId": "5ac57915e4b0b65c47d9fb15",
        "objectType": "MESSAGE"
    },
    "_msgid": "3ba03d99.33bd92"
}
    </pre>
    <h5><b>NEW</b> reaction-removed</h5>
    <p>This event is issued when an user or app has removed a reaction (e.g. emoticons) to a particular user message.</p>
    <p>Example message</p>
    <pre>
{
    "payload": "üëç",
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsType": "reaction-removed",
    "wwsReactor": "54f13685-35f7-468e-939e-28f8bed06a87",
    "wwsRelatedMessage": "5ac57915e4b0b65c47d9fb15",
    "wwsReactionType": "MESSAGE",
    "wwsEvent": {
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "reaction": "üëç",
        "time": 1522891244379,
        "type": "reaction-removed",
        "userId": "54f13685-35f7-468e-939e-28f8bed06a87",
        "objectId": "5ac57915e4b0b65c47d9fb15",
        "objectType": "MESSAGE"
    },
    "_msgid": "c0f80069.f21ec"
}
    </pre>
    <h5><b>NEW</b> space-updated</h5>
    <p>This event is issued when the space settings have been updated by the space owner.</p>
    <p>Example message</p>
    <pre>
{
    "payload": {},
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsType": "space-updated",
    "wwsUpdater": "54f13685-35f7-468e-939e-28f8bed06a87",
    "wwsSpaceProperties": {},
    "wwsUpdateCause": "other",
    "wwsEvent": {
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "spaceProperties": {},
        "time": 1522891244443,
        "type": "space-updated",
        "userId": "54f13685-35f7-468e-939e-28f8bed06a87"
    },
    "_msgid": "63b84246.a1c8cc"
}
    </pre>
    <h5><b>NEW</b> space-deleted</h5>
    <p>This event is issued when the space has been deleted by the space owner.</p>
    <p>Example message</p>
    <pre>
{
    "payload": "54f13685-35f7-468e-939e-28f8bed06a87",
    "error": null,
    "wwsSpaceId": "5ac3a40fe4b0b569843a146b",
    "wwsType": "space-deleted",
    "wwsEvent": {
        "spaceId": "5ac3a40fe4b0b569843a146b",
        "time": 1522891432336,
        "type": "space-deleted",
        "userId": "54f13685-35f7-468e-939e-28f8bed06a87"
    },
    "_msgid": "90aceb87.51f7b8"
}
    </pre>
    <h3>References</h3>
    <ul>
        <li><a href="https://developer.watsonwork.ibm.com/docs/api-reference/" target="_blank">Watson Work API</a> - Reference Documentation</li>
        <li><a href="https://developer.watsonwork.ibm.com/docs/api-reference/webhooks" target="_blank">Webhooks</a> - Reference Documentation for Webhooks</li>
        <li><a href="https://developer.watsonwork.ibm.com/docs/get-started/what-can-you-build" target="_blank">Getting Started</a> - Guide to be used as starting point</li>
        <li>TODO: <a>GitHub</a> - the nodes github repository</li>
    </ul>

</script>
